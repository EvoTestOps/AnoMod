        -:    0:Source:/social-network-microservices/src/ThriftClient.h
        -:    0:Graph:/social-network-microservices/build/src/HomeTimelineService/CMakeFiles/HomeTimelineService.dir/HomeTimelineService.cpp.gcno
        -:    0:Data:/social-network-microservices/build/src/HomeTimelineService/CMakeFiles/HomeTimelineService.dir/HomeTimelineService.cpp.gcda
        -:    0:Runs:1
        -:    0:Programs:1
        -:    1:#ifndef SOCIAL_NETWORK_MICROSERVICES_THRIFTCLIENT_H
        -:    2:#define SOCIAL_NETWORK_MICROSERVICES_THRIFTCLIENT_H
        -:    3:
        -:    4:#include <string>
        -:    5:#include <thread>
        -:    6:#include <iostream>
        -:    7:#include <chrono>
        -:    8:#include <boost/log/trivial.hpp>
        -:    9:
        -:   10:#include <thrift/protocol/TBinaryProtocol.h>
        -:   11:#include <thrift/transport/TSocket.h>
        -:   12:#include <thrift/transport/TSSLSocket.h>
        -:   13:#include <thrift/transport/TTransportUtils.h>
        -:   14:#include <thrift/stdcxx.h>
        -:   15:#include <nlohmann/json.hpp>
        -:   16:#include "logger.h"
        -:   17:#include "GenericClient.h"
        -:   18:
        -:   19:
        -:   20:namespace social_network {
        -:   21:
        -:   22:using apache::thrift::protocol::TProtocol;
        -:   23:using apache::thrift::protocol::TBinaryProtocol;
        -:   24:using apache::thrift::transport::TFramedTransport;
        -:   25:using apache::thrift::transport::TSocket;
        -:   26:using apache::thrift::transport::TSSLSocketFactory;
        -:   27:using apache::thrift::transport::TTransport;
        -:   28:using apache::thrift::TException;
        -:   29:using json = nlohmann::json;
        -:   30:
        -:   31:template<class TThriftClient>
        -:   32:class ThriftClient : public GenericClient {
        -:   33: public:
        -:   34:  ThriftClient(const std::string &addr, int port);
        -:   35:  ThriftClient(const std::string &addr, int port, int keepalive_ms, const json &config_json);
        -:   36:
        -:   37:  ThriftClient(const ThriftClient &) = delete;
        -:   38:  ThriftClient &operator=(const ThriftClient &) = delete;
        -:   39:  ThriftClient(ThriftClient<TThriftClient> &&) = default;
        -:   40:  ThriftClient &operator=(ThriftClient &&) = default;
        -:   41:
        -:   42:  ~ThriftClient() override;
        -:   43:
        -:   44:  TThriftClient *GetClient() const;
        -:   45:
        -:   46:  void Connect() override;
        -:   47:  void Disconnect() override;
        -:   48:  bool IsConnected() override;
        -:   49:
        -:   50: private:
        -:   51:  TThriftClient *_client;
        -:   52:
        -:   53:  std::shared_ptr<TSocket> _socket;
        -:   54:  std::shared_ptr<TTransport> _transport;
        -:   55:  std::shared_ptr<TProtocol> _protocol;
        -:   56:};
        -:   57:
        -:   58:template<class TThriftClient>
        -:   59:ThriftClient<TThriftClient>::ThriftClient(
        -:   60:    const std::string &addr, int port) {
        -:   61:  _addr = addr;
        -:   62:  _port = port;
        -:   63:  _socket = std::shared_ptr<TSocket>(new TSocket(addr, port));
        -:   64:  _socket->setKeepAlive(true);
        -:   65:  _transport = std::shared_ptr<TTransport>(new TFramedTransport(_socket));
        -:   66:  _protocol = std::shared_ptr<TProtocol>(new TBinaryProtocol(_transport));
        -:   67:  _client = new TThriftClient(_protocol);
        -:   68:  _connect_timestamp = 0;
        -:   69:  _keepalive_ms = 0;
        -:   70:}
        -:   71:
        -:   72:template <class TThriftClient>
function _ZN14social_network12ThriftClientINS_24PostStorageServiceClientEEC2ERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEiiRKN8nlohmann10basic_jsonISt3mapSt6vectorS8_blmdSaNSB_14adl_serializerEEE called 67 returned 100% blocks executed 44%
function _ZN14social_network12ThriftClientINS_24SocialGraphServiceClientEEC2ERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEiiRKN8nlohmann10basic_jsonISt3mapSt6vectorS8_blmdSaNSB_14adl_serializerEEE called 0 returned 0% blocks executed 0%
       67:   73:ThriftClient<TThriftClient>::ThriftClient(
       67:   74:    const std::string &addr, int port, int keepalive_ms, const json &config_json) {
call    0 returned 100%
call    1 returned 100%
call    2 returned 100%
call    3 returned 100%
call    4 never executed
call    5 never executed
call    6 never executed
call    7 never executed
call    8 never executed
call    9 never executed
call   10 never executed
call   11 never executed
call   12 never executed
call   13 never executed
call   14 never executed
call   15 never executed
       67:   75:  _addr = addr;
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0% (throw)
call    3 never executed
branch  4 never executed
branch  5 never executed
       67:   76:  _port = port;
       67:   77:  bool ssl_enabled = config_json["ssl"]["enabled"];
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0% (throw)
call    3 returned 100%
branch  4 taken 100% (fallthrough)
branch  5 taken 0% (throw)
call    6 returned 100%
branch  7 taken 100% (fallthrough)
branch  8 taken 0% (throw)
call    9 never executed
branch 10 never executed
branch 11 never executed
call   12 never executed
branch 13 never executed
branch 14 never executed
call   15 never executed
branch 16 never executed
branch 17 never executed
        -:   78:
       67:   79:  if (ssl_enabled) {
branch  0 taken 0% (fallthrough)
branch  1 taken 100%
branch  2 never executed
branch  3 never executed
    #####:   80:    std::string ca_path = config_json["ssl"]["caPath"];
call    0 never executed
branch  1 never executed
branch  2 never executed
call    3 never executed
branch  4 never executed
branch  5 never executed
call    6 never executed
branch  7 never executed
branch  8 never executed
call    9 never executed
call   10 never executed
call   11 never executed
branch 12 never executed
branch 13 never executed
call   14 never executed
branch 15 never executed
branch 16 never executed
call   17 never executed
branch 18 never executed
branch 19 never executed
call   20 never executed
call   21 never executed
    #####:   81:    std::string ciphers = config_json["ssl"]["ciphers"];
call    0 never executed
branch  1 never executed
branch  2 never executed
call    3 never executed
branch  4 never executed
branch  5 never executed
call    6 never executed
branch  7 never executed
branch  8 never executed
call    9 never executed
call   10 never executed
call   11 never executed
branch 12 never executed
branch 13 never executed
call   14 never executed
branch 15 never executed
branch 16 never executed
call   17 never executed
branch 18 never executed
branch 19 never executed
call   20 never executed
call   21 never executed
        -:   82:
    #####:   83:    std::shared_ptr<TSSLSocketFactory> factory;
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
    #####:   84:    factory = std::make_shared<TSSLSocketFactory>();
call    0 never executed
branch  1 never executed
branch  2 never executed
call    3 never executed
call    4 never executed
call    5 never executed
branch  6 never executed
branch  7 never executed
call    8 never executed
call    9 never executed
    #####:   85:    factory->ciphers(ciphers);
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
branch  6 never executed
branch  7 never executed
    #####:   86:    factory->loadTrustedCertificates(ca_path.c_str());
call    0 never executed
call    1 never executed
call    2 never executed
branch  3 never executed
branch  4 never executed
call    5 never executed
call    6 never executed
call    7 never executed
branch  8 never executed
branch  9 never executed
        -:   87:
        -:   88:    // if (config_json["ssl"]["verifyClient"]) {
        -:   89:    //   std::string cert_path = config_json["ssl"]["clientCertPath"];
        -:   90:    //   std::string key_path = config_json["ssl"]["clientKeyPath"];
        -:   91:    //   factory->loadCertificate(cert_path.c_str());
        -:   92:    //   factory->loadPrivateKey(key_path.c_str());
        -:   93:    // }
        -:   94:    // Need verify server
    #####:   95:    factory->authenticate(true);
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
branch  6 never executed
branch  7 never executed
    #####:   96:    _socket = factory->createSocket(addr, port);
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
call    6 never executed
call    7 never executed
branch  8 never executed
branch  9 never executed
call   10 never executed
call   11 never executed
        -:   97:  } else {
       67:   98:    _socket = std::shared_ptr<TSocket>(new TSocket(addr, port));
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0% (throw)
call    3 returned 100%
branch  4 taken 100% (fallthrough)
branch  5 taken 0% (throw)
call    6 returned 100%
branch  7 taken 100% (fallthrough)
branch  8 taken 0% (throw)
call    9 returned 100%
call   10 returned 100%
call   11 never executed
call   12 never executed
branch 13 never executed
branch 14 never executed
call   15 never executed
branch 16 never executed
branch 17 never executed
call   18 never executed
branch 19 never executed
branch 20 never executed
call   21 never executed
call   22 never executed
call   23 never executed
        -:   99:  }
       67:  100:  _socket->setKeepAlive(true);
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 never executed
call    5 never executed
branch  6 never executed
branch  7 never executed
       67:  101:  _transport = std::shared_ptr<TTransport>(new TFramedTransport(_socket));
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 returned 100%
branch  5 taken 100% (fallthrough)
branch  6 taken 0% (throw)
call    7 returned 100%
branch  8 taken 100% (fallthrough)
branch  9 taken 0% (throw)
call   10 returned 100%
call   11 returned 100%
call   12 returned 100%
call   13 never executed
call   14 never executed
call   15 never executed
call   16 never executed
branch 17 never executed
branch 18 never executed
call   19 never executed
branch 20 never executed
branch 21 never executed
call   22 never executed
branch 23 never executed
branch 24 never executed
call   25 never executed
call   26 never executed
call   27 never executed
call   28 never executed
call   29 never executed
       67:  102:  _protocol = std::shared_ptr<TProtocol>(new TBinaryProtocol(_transport));
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 returned 100%
branch  5 taken 100% (fallthrough)
branch  6 taken 0% (throw)
call    7 returned 100%
branch  8 taken 100% (fallthrough)
branch  9 taken 0% (throw)
call   10 returned 100%
call   11 returned 100%
call   12 returned 100%
call   13 never executed
call   14 never executed
call   15 never executed
call   16 never executed
branch 17 never executed
branch 18 never executed
call   19 never executed
branch 20 never executed
branch 21 never executed
call   22 never executed
branch 23 never executed
branch 24 never executed
call   25 never executed
call   26 never executed
call   27 never executed
call   28 never executed
call   29 never executed
       67:  103:  _client = new TThriftClient(_protocol);
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 returned 100%
branch  5 taken 100% (fallthrough)
branch  6 taken 0% (throw)
call    7 returned 100%
call    8 never executed
call    9 never executed
call   10 never executed
call   11 never executed
branch 12 never executed
branch 13 never executed
call   14 never executed
branch 15 never executed
branch 16 never executed
call   17 never executed
call   18 never executed
call   19 never executed
      201:  104:  _connect_timestamp = std::chrono::duration_cast<std::chrono::milliseconds>(
call    0 returned 100%
call    1 never executed
      134:  105:                           std::chrono::system_clock::now().time_since_epoch())
call    0 returned 100%
call    1 never executed
      134:  106:                           .count();
call    0 returned 100%
call    1 returned 100%
call    2 never executed
call    3 never executed
       67:  107:  _keepalive_ms = keepalive_ms;
       67:  108:}
        -:  109:
        -:  110:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_24PostStorageServiceClientEED0Ev called 66 returned 100% blocks executed 100%
function _ZN14social_network12ThriftClientINS_24PostStorageServiceClientEED2Ev called 66 returned 100% blocks executed 90%
function _ZN14social_network12ThriftClientINS_24SocialGraphServiceClientEED0Ev called 0 returned 0% blocks executed 0%
function _ZN14social_network12ThriftClientINS_24SocialGraphServiceClientEED2Ev called 0 returned 0% blocks executed 0%
      132:  111:ThriftClient<TThriftClient>::~ThriftClient() {
       66:  112:  Disconnect();
call    0 returned 100%
call    1 never executed
       66:  113:  delete _client;
branch  0 taken 100% (fallthrough)
branch  1 taken 0%
call    2 returned 100%
branch  3 never executed
branch  4 never executed
call    5 never executed
      198:  114:}
call    0 returned 100%
call    1 returned 100%
call    2 returned 100%
call    3 returned 100%
call    4 returned 100%
call    5 returned 100%
branch  6 taken 0% (fallthrough)
branch  7 taken 100%
call    8 never executed
call    9 never executed
call   10 never executed
call   11 never executed
call   12 never executed
call   13 never executed
call   14 never executed
branch 15 never executed
branch 16 never executed
call   17 never executed
        -:  115:
        -:  116:template<class TThriftClient>
function _ZNK14social_network12ThriftClientINS_24PostStorageServiceClientEE9GetClientEv called 200 returned 100% blocks executed 100%
function _ZNK14social_network12ThriftClientINS_24SocialGraphServiceClientEE9GetClientEv called 0 returned 0% blocks executed 0%
      200:  117:TThriftClient *ThriftClient<TThriftClient>::GetClient() const {
      200:  118:  return _client;
        -:  119:}
        -:  120:
        -:  121:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_24PostStorageServiceClientEE11IsConnectedEv called 266 returned 100% blocks executed 100%
function _ZN14social_network12ThriftClientINS_24SocialGraphServiceClientEE11IsConnectedEv called 0 returned 0% blocks executed 0%
      266:  122:bool ThriftClient<TThriftClient>::IsConnected() {
      266:  123:  return _transport->isOpen();
call    0 returned 100%
call    1 returned 100%
call    2 never executed
call    3 never executed
        -:  124:}
        -:  125:
        -:  126:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_24PostStorageServiceClientEE7ConnectEv called 200 returned 100% blocks executed 44%
function _ZN14social_network12ThriftClientINS_24SocialGraphServiceClientEE7ConnectEv called 0 returned 0% blocks executed 0%
      200:  127:void ThriftClient<TThriftClient>::Connect() {
      200:  128:  if (!IsConnected()) {
call    0 returned 100%
branch  1 taken 34% (fallthrough)
branch  2 taken 67%
call    3 never executed
branch  4 never executed
branch  5 never executed
        -:  129:    try {
       67:  130:      _transport->open();
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 never executed
call    5 never executed
branch  6 never executed
branch  7 never executed
    =====:  131:    } catch (TException &tx) {
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
    =====:  132:      throw tx;
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
call    6 never executed
call    7 never executed
branch  8 never executed
branch  9 never executed
call   10 never executed
call   11 never executed
        -:  133:    }
        -:  134:  }
      200:  135:}
branch  0 never executed
branch  1 never executed
call    2 never executed
branch  3 never executed
branch  4 never executed
call    5 never executed
        -:  136:
        -:  137:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_24PostStorageServiceClientEE10DisconnectEv called 66 returned 100% blocks executed 44%
function _ZN14social_network12ThriftClientINS_24SocialGraphServiceClientEE10DisconnectEv called 0 returned 0% blocks executed 0%
       66:  138:void ThriftClient<TThriftClient>::Disconnect() {
       66:  139:  if (IsConnected()) {
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0%
call    3 never executed
branch  4 never executed
branch  5 never executed
        -:  140:    try {
       66:  141:      _transport->close();
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 never executed
call    5 never executed
branch  6 never executed
branch  7 never executed
    =====:  142:    } catch (TException &tx) {
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
    =====:  143:      throw tx;
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
call    6 never executed
call    7 never executed
branch  8 never executed
branch  9 never executed
call   10 never executed
call   11 never executed
        -:  144:    }
        -:  145:  }
       66:  146:}
branch  0 never executed
branch  1 never executed
call    2 never executed
branch  3 never executed
branch  4 never executed
call    5 never executed
        -:  147:
        -:  148:} // namespace social_network
        -:  149:
        -:  150:
        -:  151:#endif //SOCIAL_NETWORK_MICROSERVICES_THRIFTCLIENT_H
