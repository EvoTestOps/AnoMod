        -:    0:Source:/social-network-microservices/src/ThriftClient.h
        -:    0:Graph:/social-network-microservices/build/src/SocialGraphService/CMakeFiles/SocialGraphService.dir/SocialGraphService.cpp.gcno
        -:    0:Data:/social-network-microservices/build/src/SocialGraphService/CMakeFiles/SocialGraphService.dir/SocialGraphService.cpp.gcda
        -:    0:Runs:1
        -:    0:Programs:1
        -:    1:#ifndef SOCIAL_NETWORK_MICROSERVICES_THRIFTCLIENT_H
        -:    2:#define SOCIAL_NETWORK_MICROSERVICES_THRIFTCLIENT_H
        -:    3:
        -:    4:#include <string>
        -:    5:#include <thread>
        -:    6:#include <iostream>
        -:    7:#include <chrono>
        -:    8:#include <boost/log/trivial.hpp>
        -:    9:
        -:   10:#include <thrift/protocol/TBinaryProtocol.h>
        -:   11:#include <thrift/transport/TSocket.h>
        -:   12:#include <thrift/transport/TSSLSocket.h>
        -:   13:#include <thrift/transport/TTransportUtils.h>
        -:   14:#include <thrift/stdcxx.h>
        -:   15:#include <nlohmann/json.hpp>
        -:   16:#include "logger.h"
        -:   17:#include "GenericClient.h"
        -:   18:
        -:   19:
        -:   20:namespace social_network {
        -:   21:
        -:   22:using apache::thrift::protocol::TProtocol;
        -:   23:using apache::thrift::protocol::TBinaryProtocol;
        -:   24:using apache::thrift::transport::TFramedTransport;
        -:   25:using apache::thrift::transport::TSocket;
        -:   26:using apache::thrift::transport::TSSLSocketFactory;
        -:   27:using apache::thrift::transport::TTransport;
        -:   28:using apache::thrift::TException;
        -:   29:using json = nlohmann::json;
        -:   30:
        -:   31:template<class TThriftClient>
        -:   32:class ThriftClient : public GenericClient {
        -:   33: public:
        -:   34:  ThriftClient(const std::string &addr, int port);
        -:   35:  ThriftClient(const std::string &addr, int port, int keepalive_ms, const json &config_json);
        -:   36:
        -:   37:  ThriftClient(const ThriftClient &) = delete;
        -:   38:  ThriftClient &operator=(const ThriftClient &) = delete;
        -:   39:  ThriftClient(ThriftClient<TThriftClient> &&) = default;
        -:   40:  ThriftClient &operator=(ThriftClient &&) = default;
        -:   41:
        -:   42:  ~ThriftClient() override;
        -:   43:
        -:   44:  TThriftClient *GetClient() const;
        -:   45:
        -:   46:  void Connect() override;
        -:   47:  void Disconnect() override;
        -:   48:  bool IsConnected() override;
        -:   49:
        -:   50: private:
        -:   51:  TThriftClient *_client;
        -:   52:
        -:   53:  std::shared_ptr<TSocket> _socket;
        -:   54:  std::shared_ptr<TTransport> _transport;
        -:   55:  std::shared_ptr<TProtocol> _protocol;
        -:   56:};
        -:   57:
        -:   58:template<class TThriftClient>
        -:   59:ThriftClient<TThriftClient>::ThriftClient(
        -:   60:    const std::string &addr, int port) {
        -:   61:  _addr = addr;
        -:   62:  _port = port;
        -:   63:  _socket = std::shared_ptr<TSocket>(new TSocket(addr, port));
        -:   64:  _socket->setKeepAlive(true);
        -:   65:  _transport = std::shared_ptr<TTransport>(new TFramedTransport(_socket));
        -:   66:  _protocol = std::shared_ptr<TProtocol>(new TBinaryProtocol(_transport));
        -:   67:  _client = new TThriftClient(_protocol);
        -:   68:  _connect_timestamp = 0;
        -:   69:  _keepalive_ms = 0;
        -:   70:}
        -:   71:
        -:   72:template <class TThriftClient>
function _ZN14social_network12ThriftClientINS_17UserServiceClientEEC2ERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEiiRKN8nlohmann10basic_jsonISt3mapSt6vectorS8_blmdSaNSB_14adl_serializerEEE called 219 returned 100% blocks executed 44%
      219:   73:ThriftClient<TThriftClient>::ThriftClient(
      219:   74:    const std::string &addr, int port, int keepalive_ms, const json &config_json) {
call    0 returned 100%
call    1 returned 100%
call    2 returned 100%
call    3 returned 100%
call    4 never executed
call    5 never executed
call    6 never executed
call    7 never executed
      219:   75:  _addr = addr;
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0% (throw)
      219:   76:  _port = port;
      219:   77:  bool ssl_enabled = config_json["ssl"]["enabled"];
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0% (throw)
call    3 returned 100%
branch  4 taken 100% (fallthrough)
branch  5 taken 0% (throw)
call    6 returned 100%
branch  7 taken 100% (fallthrough)
branch  8 taken 0% (throw)
        -:   78:
      219:   79:  if (ssl_enabled) {
branch  0 taken 0% (fallthrough)
branch  1 taken 100%
    #####:   80:    std::string ca_path = config_json["ssl"]["caPath"];
call    0 never executed
branch  1 never executed
branch  2 never executed
call    3 never executed
branch  4 never executed
branch  5 never executed
call    6 never executed
branch  7 never executed
branch  8 never executed
call    9 never executed
call   10 never executed
    #####:   81:    std::string ciphers = config_json["ssl"]["ciphers"];
call    0 never executed
branch  1 never executed
branch  2 never executed
call    3 never executed
branch  4 never executed
branch  5 never executed
call    6 never executed
branch  7 never executed
branch  8 never executed
call    9 never executed
call   10 never executed
        -:   82:
    #####:   83:    std::shared_ptr<TSSLSocketFactory> factory;
call    0 never executed
call    1 never executed
    #####:   84:    factory = std::make_shared<TSSLSocketFactory>();
call    0 never executed
branch  1 never executed
branch  2 never executed
call    3 never executed
call    4 never executed
    #####:   85:    factory->ciphers(ciphers);
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
    #####:   86:    factory->loadTrustedCertificates(ca_path.c_str());
call    0 never executed
call    1 never executed
call    2 never executed
branch  3 never executed
branch  4 never executed
        -:   87:
        -:   88:    // if (config_json["ssl"]["verifyClient"]) {
        -:   89:    //   std::string cert_path = config_json["ssl"]["clientCertPath"];
        -:   90:    //   std::string key_path = config_json["ssl"]["clientKeyPath"];
        -:   91:    //   factory->loadCertificate(cert_path.c_str());
        -:   92:    //   factory->loadPrivateKey(key_path.c_str());
        -:   93:    // }
        -:   94:    // Need verify server
    #####:   95:    factory->authenticate(true);
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
    #####:   96:    _socket = factory->createSocket(addr, port);
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
        -:   97:  } else {
      219:   98:    _socket = std::shared_ptr<TSocket>(new TSocket(addr, port));
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0% (throw)
call    3 returned 100%
branch  4 taken 100% (fallthrough)
branch  5 taken 0% (throw)
call    6 returned 100%
branch  7 taken 100% (fallthrough)
branch  8 taken 0% (throw)
call    9 returned 100%
call   10 returned 100%
call   11 never executed
        -:   99:  }
      219:  100:  _socket->setKeepAlive(true);
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
      219:  101:  _transport = std::shared_ptr<TTransport>(new TFramedTransport(_socket));
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 returned 100%
branch  5 taken 100% (fallthrough)
branch  6 taken 0% (throw)
call    7 returned 100%
branch  8 taken 100% (fallthrough)
branch  9 taken 0% (throw)
call   10 returned 100%
call   11 returned 100%
call   12 returned 100%
call   13 never executed
call   14 never executed
      219:  102:  _protocol = std::shared_ptr<TProtocol>(new TBinaryProtocol(_transport));
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 returned 100%
branch  5 taken 100% (fallthrough)
branch  6 taken 0% (throw)
call    7 returned 100%
branch  8 taken 100% (fallthrough)
branch  9 taken 0% (throw)
call   10 returned 100%
call   11 returned 100%
call   12 returned 100%
call   13 never executed
call   14 never executed
      219:  103:  _client = new TThriftClient(_protocol);
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
call    4 returned 100%
branch  5 taken 100% (fallthrough)
branch  6 taken 0% (throw)
call    7 returned 100%
call    8 never executed
call    9 never executed
      657:  104:  _connect_timestamp = std::chrono::duration_cast<std::chrono::milliseconds>(
call    0 returned 100%
      438:  105:                           std::chrono::system_clock::now().time_since_epoch())
call    0 returned 100%
      438:  106:                           .count();
call    0 returned 100%
call    1 returned 100%
      219:  107:  _keepalive_ms = keepalive_ms;
      219:  108:}
        -:  109:
        -:  110:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_17UserServiceClientEED0Ev called 182 returned 100% blocks executed 100%
function _ZN14social_network12ThriftClientINS_17UserServiceClientEED2Ev called 182 returned 100% blocks executed 90%
      364:  111:ThriftClient<TThriftClient>::~ThriftClient() {
      182:  112:  Disconnect();
call    0 returned 100%
      182:  113:  delete _client;
branch  0 taken 100% (fallthrough)
branch  1 taken 0%
call    2 returned 100%
      546:  114:}
call    0 returned 100%
call    1 returned 100%
call    2 returned 100%
call    3 returned 100%
call    4 returned 100%
call    5 returned 100%
branch  6 taken 0% (fallthrough)
branch  7 taken 100%
call    8 never executed
        -:  115:
        -:  116:template<class TThriftClient>
function _ZNK14social_network12ThriftClientINS_17UserServiceClientEE9GetClientEv called 75238 returned 100% blocks executed 100%
    75238:  117:TThriftClient *ThriftClient<TThriftClient>::GetClient() const {
    75238:  118:  return _client;
        -:  119:}
        -:  120:
        -:  121:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_17UserServiceClientEE11IsConnectedEv called 75418 returned 99% blocks executed 100%
    75418:  122:bool ThriftClient<TThriftClient>::IsConnected() {
    75418:  123:  return _transport->isOpen();
call    0 returned 99%
call    1 returned 99%
        -:  124:}
        -:  125:
        -:  126:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_17UserServiceClientEE7ConnectEv called 75226 returned 99% blocks executed 44%
    75226:  127:void ThriftClient<TThriftClient>::Connect() {
    75226:  128:  if (!IsConnected()) {
call    0 returned 99%
branch  1 taken 1% (fallthrough)
branch  2 taken 99%
        -:  129:    try {
      219:  130:      _transport->open();
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
    =====:  131:    } catch (TException &tx) {
call    0 never executed
call    1 never executed
    =====:  132:      throw tx;
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
        -:  133:    }
        -:  134:  }
    75246:  135:}
branch  0 never executed
branch  1 never executed
call    2 never executed
        -:  136:
        -:  137:template<class TThriftClient>
function _ZN14social_network12ThriftClientINS_17UserServiceClientEE10DisconnectEv called 182 returned 100% blocks executed 44%
      182:  138:void ThriftClient<TThriftClient>::Disconnect() {
      182:  139:  if (IsConnected()) {
call    0 returned 100%
branch  1 taken 100% (fallthrough)
branch  2 taken 0%
        -:  140:    try {
      182:  141:      _transport->close();
call    0 returned 100%
call    1 returned 100%
branch  2 taken 100% (fallthrough)
branch  3 taken 0% (throw)
    =====:  142:    } catch (TException &tx) {
call    0 never executed
call    1 never executed
    =====:  143:      throw tx;
call    0 never executed
call    1 never executed
branch  2 never executed
branch  3 never executed
call    4 never executed
call    5 never executed
        -:  144:    }
        -:  145:  }
      182:  146:}
branch  0 never executed
branch  1 never executed
call    2 never executed
        -:  147:
        -:  148:} // namespace social_network
        -:  149:
        -:  150:
        -:  151:#endif //SOCIAL_NETWORK_MICROSERVICES_THRIFTCLIENT_H
